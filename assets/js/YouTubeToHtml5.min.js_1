"use strict";function _typeof(t){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function YouTubeToHtml5(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};for(var o in this.hooks={},this.options={},this.defaultOptions)this.options[o]=o in t?t[o]:this.defaultOptions[o];this.options.autoload&&this.load()}YouTubeToHtml5.prototype.defaultOptions={selector:"video[data-yt2html5]",attribute:"data-yt2html5",formats:"*",autoload:!0,withAudio:!1},YouTubeToHtml5.prototype.globalHooks={},YouTubeToHtml5.prototype.getHooks=function(t,o){var e=[];if(t in this.globalHooks){var n=this.globalHooks[t];n=(n=n.filter(function(t){return t.name===o})).sort(function(t,o){return t.priority-o.priority}),e=e.concat(n)}if(t in this.hooks){var i=this.hooks[t];i=(i=i.filter(function(t){return t.name===o})).sort(function(t,o){return t.priority-o.priority}),e=e.concat(i)}return e},YouTubeToHtml5.prototype.addHook=function(t,o){t in this.globalHooks||(this.globalHooks[t]=[]),t in this.hooks||(this.hooks[t]=[]),"global"in o&&o.global?this.globalHooks[t].push(o):this.hooks[t].push(o)},YouTubeToHtml5.prototype.addAction=function(t,o){var e=2<arguments.length&&void 0!==arguments[2]?arguments[2]:10,n=!!(3<arguments.length&&void 0!==arguments[3])&&arguments[3];this.addHook("actions",{name:t,callback:o,priority:e,global:n})},YouTubeToHtml5.prototype.doAction=function(t){for(var o=this.getHooks("actions",t),e=arguments.length,n=Array(1<e?e-1:0),i=1;i<e;i++)n[i-1]=arguments[i];for(var r=0;r<o.length;r++){var a;(a=o[r]).callback.apply(a,n)}},YouTubeToHtml5.prototype.addFilter=function(t,o){var e=2<arguments.length&&void 0!==arguments[2]?arguments[2]:10,n=!!(3<arguments.length&&void 0!==arguments[3])&&arguments[3];this.addHook("filters",{name:t,callback:o,priority:e,global:n})},YouTubeToHtml5.prototype.applyFilters=function(t,o){for(var e=this.getHooks("filters",t),n=arguments.length,i=Array(2<n?n-2:0),r=2;r<n;r++)i[r-2]=arguments[r];for(var a=0;a<e.length;a++){var l;o=(l=e[a]).callback.apply(l,[o].concat(i))}return o},YouTubeToHtml5.prototype.itagMap={18:"360p",22:"720p",37:"1080p",38:"3072p",82:"360p3d",83:"480p3d",84:"720p3d",85:"1080p3d",133:"240pna",134:"360pna",135:"480pna",136:"720pna",137:"1080pna",264:"1440pna",298:"720p60",299:"1080p60na",160:"144pna",139:"48kbps",140:"128kbps",141:"256kbps"},YouTubeToHtml5.prototype.urlToId=function(t){var o=t.match(/^(?:http(?:s)?:\/\/)?(?:www\.)?(?:m\.)?(?:youtu\.be\/|(?:(?:youtube-nocookie\.com\/|youtube\.com\/)(?:(?:watch)?\?(?:.*&)?v(?:i)?=|(?:embed|v|vi|user)\/)))([a-zA-Z0-9\-_]*)/);return Array.isArray(o)&&o[1]?o[1]:t},YouTubeToHtml5.prototype.fetch=function(t){return new Promise((o,e)=>{var n=new XMLHttpRequest;n.open("GET",t,!0),n.onreadystatechange=function(){4===this.readyState&&(this.status>=200&&this.status<400?o(this.responseText):e(this))},n.send(),n=null})},YouTubeToHtml5.prototype.getAllowedFormats=function(){var t=[];return Array.isArray(this.options.formats)?t=this.options.formats:this.itagMap[this.options.formats]?t=[this.options.formats]:"*"===this.options.formats&&(t=Object.values(this.itagMap).sort()),t},YouTubeToHtml5.prototype.getElements=function(t){var o=null;return t&&(o=NodeList.prototype.isPrototypeOf(t)||HTMLCollection.prototype.isPrototypeOf(t)?t:"object"===_typeof(t)&&"nodeType"in t&&t.nodeType?[t]:document.querySelectorAll(this.options.selector)),o=Array.from(o||""),this.applyFilters("elements",o)},YouTubeToHtml5.prototype.youtubeDataApiEndpoint=function(t){var o=~~(33*Math.random()),e=encodeURIComponent("https://www.youtube.com/get_video_info?video_id=".concat(t,"&el=embedded&hl=en_US")),n="https://images".concat(o,"-focus-opensocial.googleusercontent.com/gadgets/proxy?container=none&url=").concat(e);return this.applyFilters("api.endpoint",n,t,o)},YouTubeToHtml5.prototype.parseUriString=function(t){return t.split("&").reduce(function(t,o){var e=o.split("=").map(function(t){return decodeURIComponent(t.replace("+"," "))});return t[e[0]]=e[1],t},{})},YouTubeToHtml5.prototype.canPlayType=function(t){var o=null,e=(o=/^audio/i.test(t)?document.createElement("audio"):document.createElement("video"))&&"function"==typeof o.canPlayType?o.canPlayType(t):"unknown";return e||"no"},YouTubeToHtml5.prototype.load=function(){var t=this,o=this.getElements(this.options.selector);o&&o.length&&o.forEach(function(o){t.loadSingle(o)})},YouTubeToHtml5.prototype.loadSingle=function(t){var o=this,e=(1<arguments.length&&void 0!==arguments[1]?arguments[1]:null)||this.options.attribute;if(t.getAttribute(e)){var n=this.urlToId(t.getAttribute(e)),i=this.youtubeDataApiEndpoint(n);this.doAction("api.before",t),this.fetch(i).then(function(e){if(e){var n=e;let r=[],a=o.parseUriString(n);a.player_response=JSON.parse(a.player_response),a.fflags=o.parseUriString(a.fflags),a=o.applyFilters("api.response",a,n);var i=new XMLHttpRequest;i.open("GET","/yt_info.php?url=https://youtu.be/"+a.player_response.videoDetails.videoId,!0),i.onreadystatechange=function(){if(4==i.readyState&&200==i.status){for(var e in l=JSON.parse(i.responseText).links){var n=l[e];if(n&&"itag"in n&&o.itagMap[n.itag]){let t={_raw:n,itag:n.itag,url:null,label:null,type:"unknown",mime:"unknown",hasAudio:!1,browserSupport:"unknown"};"url"in n&&n.url&&(t.url=n.url);var a=n.format.split(", ");("audioQuality"in n&&n.audioQuality||-1!==a.indexOf("audio"))&&(t.hasAudio=!0),"qualityLabel"in n&&n.qualityLabel?t.label=n.qualityLabel:t.label=o.itagMap[n.itag],null!=a&&(-1!==a.indexOf("video")?t.type="video":-1!==a.indexOf("audio")&&(t.type="audio"),t.mime=a[0],t.browserSupport=o.canPlayType(`${t.type}/${t.mime}`)),t.url&&r.push(t)}}var l=r;if(l&&Array.isArray(l)){(l=l.filter(function(o){return o.type===t.tagName.toLowerCase()})).sort(function(t,o){const e={unknown:-1,no:-1,maybe:0,probably:1};return e[t.browserSupport]+e[o.browserSupport]}),o.options.withAudio&&(l=l.filter(function(t){return t.hasAudio}));const e=o.getAllowedFormats();var u=null,p=null;for(let t=0;t<e.length;t++){const n=e[t],i=l.filter(t=>o.itagMap[t.itag]===n);if(i&&i.length){u=i.shift(),p=n;break}}let n={src:"",type:""};(u=o.applyFilters("video.stream",u,t,p,l))&&"url"in u&&u.url&&(n.src=u.url),u.type&&"unknown"!==u.type&&u.mime&&"unknown"!==u.mime&&(n.type=`${u.type}/${u.mime}`),n.src=o.applyFilters("video.source",n.src,u,t,p,l),n.src&&"function"==typeof n.src.toString&&n.src.toString().length?(t.src=n.src,n.type&&n.type.length&&(t.type=n.type)):console.warn(`YouTubeToHtml5 unable to load video for ID: ${videoId}`)}}},i.send()}}).finally(function(e){o.doAction("api.after",t,e)})}},"object"===("undefined"==typeof module?"undefined":_typeof(module))&&"object"===_typeof(module.exports)&&(module.exports=YouTubeToHtml5);